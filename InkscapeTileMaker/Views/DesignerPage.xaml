<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="InkscapeTileMaker.Views.DesignerPage"

             xmlns:views="clr-namespace:InkscapeTileMaker.Views"
             xmlns:vms="clr-namespace:InkscapeTileMaker.ViewModels"
             xmlns:ctrls="clr-namespace:InkscapeTileMaker.Controls"
             x:DataType="vms:DesignerViewModel"

             xmlns:ska="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             
             xmlns:conv="clr-namespace:InkscapeTileMaker.Converters">
            
    <ContentPage.Resources>
        <conv:DecimalToPercentageConverter x:Key="DecimalToPercentageConverter" />
        <toolkit:EnumToBoolConverter x:Key="ShowTileSetConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:DesignerMode>TileSet</vms:DesignerMode>
                <vms:DesignerMode>Paint</vms:DesignerMode>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>
        <toolkit:EnumToBoolConverter x:Key="ShowIndividualTileConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:DesignerMode>SingleTile</vms:DesignerMode>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>
        <toolkit:EnumToBoolConverter x:Key="PreviewIsPaintConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:PreviewMode>Paint</vms:PreviewMode>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>
        <conv:EnumToItemsSourceConverter x:Key="EnumToItemsSourceConverter" />
        <conv:EnumToStringConverter x:Key="EnumToStringConverter" />
        <toolkit:IsNotNullConverter x:Key="IsNotNullConverter" />
        <toolkit:IsEqualConverter x:Key="IsEqualConverter" />

        <toolkit:EnumToBoolConverter x:Key="IsCursorToolSelectedConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:PaintTool>Cursor</vms:PaintTool>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>

        <toolkit:EnumToBoolConverter x:Key="IsPaintToolSelectedConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:PaintTool>Paint</vms:PaintTool>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>

        <toolkit:EnumToBoolConverter x:Key="IsEraserToolSelectedConverter">
            <toolkit:EnumToBoolConverter.TrueValues>
                <vms:PaintTool>Eraser</vms:PaintTool>
            </toolkit:EnumToBoolConverter.TrueValues>
        </toolkit:EnumToBoolConverter>
    </ContentPage.Resources>

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="File">
            <MenuFlyoutItem Text="New Design"
                             Command="{Binding NewDesignCommand}" />
            <MenuFlyoutItem Text="Open Design"
                             Command="{Binding OpenDesignCommand}" />
            <MenuFlyoutItem Text="Save Design"
                             Command="{Binding SaveDesignCommand}" />
            <MenuFlyoutItem Text="Save Design As..."
                             Command="{Binding SaveDesignAsCommand}" />
            <MenuFlyoutSeparator />
            <MenuFlyoutItem Text="Exit"
                             Command="{Binding ExitCommand}" />
        </MenuBarItem>
        <MenuBarItem Text="Export">
            <MenuFlyoutSubItem Text="Tileset Image">
                <MenuFlyoutItem Text="PNG"
                                Command="{Binding ExportTilesetImageCommand}" CommandParameter="png" />
                <MenuFlyoutItem Text="SVG"
                                Command="{Binding ExportTilesetImageCommand}" CommandParameter="svg" />
            </MenuFlyoutSubItem>
            <MenuFlyoutSubItem Text="Selected Tile Image"
                               IsEnabled="{Binding SelectedTile, Converter={StaticResource IsNotNullConverter}}">
                <MenuFlyoutItem Text="PNG"
                    Command="{Binding ExportSelectedTileImageCommand}" CommandParameter="png" />
                <!--<MenuFlyoutItem Text="SVG"
                    Command="{Binding ExportSelectedTileImageCommand}" CommandParameter="svg" />-->
            </MenuFlyoutSubItem>
            <MenuFlyoutSeparator />
            <MenuFlyoutSubItem Text="Seperated Tiles">
                <MenuFlyoutItem Text="PNG"
                                Command="{Binding ExportSeparatedTilesPngCommand}" />
                <!--<MenuFlyoutItem Text="SVG"
                                Command="{Binding ExportSeparatedTilesSvgCommand}" />-->
                <MenuFlyoutItem Text="Unity Package"
                                Command="{Binding ExportSeparatedTilesUnityPackageCommand}" />
            </MenuFlyoutSubItem>
        </MenuBarItem>
    </ContentPage.MenuBarItems>

    <toolkit:DockLayout ShouldExpandLastChild="True">

        <Border WidthRequest="400"
                Margin="10"
                Stroke="LightGray"
                toolkit:DockLayout.DockPosition="Left">
            <Grid ColumnDefinitions="*">
                <views:TileSetView BindingContext="{Binding .}" 
                                   IsVisible="{Binding SelectedDesignerMode, Converter={StaticResource ShowTileSetConverter}}" 
                                   toolkit:DockLayout.DockPosition="Left"
                                   Grid.Column="0"/>
                <views:IndividualTileView BindingContext="{Binding .}" 
                                          IsVisible="{Binding SelectedDesignerMode, Converter={StaticResource ShowIndividualTileConverter}}" 
                                          toolkit:DockLayout.DockPosition="Left"
                                          Grid.Column="0"/>
            </Grid>
        </Border>



        <Grid toolkit:DockLayout.DockPosition="None"
              Margin="10"
              RowDefinitions="75, *">
            <Grid Grid.Row="0"
                  Grid.RowSpan="1"
                  ColumnDefinitions="Auto, *">
                <HorizontalStackLayout Grid.Column="0"
                                       HorizontalOptions="Start">
                    <Picker Title="Preview Mode"
                        VerticalOptions="Start"
                        FontSize="Micro"
                        Margin="5,0,0,0"
                        ItemsSource="{Binding SelectedPreviewMode, Converter={StaticResource EnumToItemsSourceConverter}}"
                        SelectedItem="{Binding SelectedPreviewMode, Mode=TwoWay}"
                        ItemDisplayBinding="{Binding Converter={StaticResource EnumToStringConverter}}"
                        PropertyChanged="PreviewModePickerChanged"/>
                    <Picker Title="Zoom"
                        VerticalOptions="Start"
                        FontSize="Micro"
                        Margin="0"
                        ItemsSource="{Binding ZoomLevels}"
                        ItemDisplayBinding="{Binding Converter={StaticResource DecimalToPercentageConverter}}"
                        SelectedItem="{Binding SelectedZoomLevel, Mode=TwoWay}" />

                    <Border IsVisible="{Binding SelectedPreviewMode, Converter={StaticResource PreviewIsPaintConverter}}"
                            Margin="5" StrokeThickness="0">
                        <Grid RowDefinitions="Auto, 40">
                            <Label Text="Tools" FontSize="Micro" Grid.Row="0" Margin="2"/>
                            <HorizontalStackLayout Grid.Row="1" Spacing="5" Padding="5,0">

                                <ctrls:ToolIcon ToolName="Cursor"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Source="cursor.png"
                                    Command="{Binding SelectToolCommand}"
                                    CommandParameter="Cursor"
                                    IsSelected="{Binding SelectedPaintTool, Converter={StaticResource IsCursorToolSelectedConverter}}"/>

                                <ctrls:ToolIcon ToolName="Paint"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Source="paint.png"
                                    Command="{Binding SelectToolCommand}"
                                    CommandParameter="Paint"
                                    IsSelected="{Binding SelectedPaintTool, Converter={StaticResource IsPaintToolSelectedConverter}}"/>

                                <ctrls:ToolIcon ToolName="Eraser"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    Source="eraser.png"
                                    Command="{Binding SelectToolCommand}"
                                    CommandParameter="Eraser"
                                    IsSelected="{Binding SelectedPaintTool, Converter={StaticResource IsEraserToolSelectedConverter}}"/>

                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </HorizontalStackLayout>
                <HorizontalStackLayout Grid.Column="1"
                                       HorizontalOptions="End">
                    <Button Text="Reset View"
                        VerticalOptions="Start"
                        FontSize="Micro"
                        Margin="5,0,0,0"
                        Command="{Binding ResetViewCommand}" />
                </HorizontalStackLayout>
            </Grid>
            <ska:SKCanvasView
                x:Name="PreviewCanvasView"
                PaintSurface="OnPreviewCanvasViewPaintSurface"
                EnableTouchEvents="True"
                Grid.Row="1"
                Grid.RowSpan="1">
                <ska:SKCanvasView.GestureRecognizers>
                    <PointerGestureRecognizer
                        PointerMoved="OnCanvasViewPointerMoved"
                        PointerPressed="OnCanvasViewPointerPressed"
                        PointerReleased="OnCanvasViewPointerReleased"
                        Buttons="Primary,Secondary"/>
                </ska:SKCanvasView.GestureRecognizers>
            </ska:SKCanvasView>
        </Grid>
    </toolkit:DockLayout>
</ContentPage>